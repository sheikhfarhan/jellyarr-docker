# --- Global Options ---
{
    # 1. Dynamic DNS
    dynamic_dns {
        provider cloudflare {env.CLOUDFLARE_API_TOKEN}
        domains {
            {env.ROOT_DOMAIN} jellyfin requests gotify
        }
    }

    # 2. CrowdSec (The "Brain")
    crowdsec {
        api_url http://crowdsec:8080
        api_key {env.CROWDSEC_API_KEY}
        ticker_interval 15s
    }

    # 3. Internal Logging
    log {
        output file /var/log/caddy/caddy.log {
            roll_size 10mb
            roll_keep 5
        }
        format json {
            time_local
        }
    }
}

# --------------------------------------------------
# 1. JELLYFIN (Media Server)
# --------------------------------------------------
jellyfin.{env.ROOT_DOMAIN} {
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
        resolvers 1.1.1.1
    }

    # Define Internal IPs (Docker Network + LAN)
    @internal {
        remote_ip 172.20.0.0/24 192.168.0.0/16 127.0.0.1
        #IPv6 Ranges (Docker IPv6 + Localhost IPv6)
        remote_ip 2001:db8:abc2::/64 ::1
    }



    # Skip logging for internal IPs
    log_skip @internal
    
    # For everything else, log for Crowdsec
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json {
            time_local
        }
    }

    # --- GEO-BLOCKING ---
    @geo_sg {
        maxmind_geolocation {
            db_path "/etc/caddy/GeoLite2-Country.mmdb"
            allow_countries SG
        }
    }

    # Allowed Traffic Handler
    handle @geo_sg {
        # 1. CrowdSec Check
        route {
            crowdsec
        }
        # Reverse Proxy
        reverse_proxy http://jellyfin:8096 {
            header_up X-Real-IP {remote_host}
         }
    }

    # Blocked Traffic Handler
    handle {
        respond "Access Denied: Geo-Block Active" 403
    }
}

# --------------------------------------------------
# 2. JELLYSEERR (Requests)
# --------------------------------------------------
requests.{env.ROOT_DOMAIN} {
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
        resolvers 1.1.1.1
    }

    # Define Internal IPs (Docker Network + LAN)
    @internal {
        remote_ip 172.20.0.0/24 192.168.0.0/16 127.0.0.1
        #IPv6 Ranges (Docker IPv6 + Localhost IPv6)
        remote_ip 2001:db8:abc2::/64 ::1
    }

    # Skip logging for internal IPs
    log_skip @internal

    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json {
            time_local
        }
    }

    # Re-use the same logic
    @geo_sg {
        maxmind_geolocation {
            db_path "/etc/caddy/GeoLite2-Country.mmdb"
            allow_countries SG
        }
    }

    handle @geo_sg {
        route {
            crowdsec
        }
        reverse_proxy http://jellyseerr:5055 {
            header_up X-Real-IP {remote_host}
        }
    }

    handle {
        respond "Access Denied: Geo-Block Active" 403
    }
}

# --------------------------------------------------
# 3. GOTIFY (Notifications)
# --------------------------------------------------
gotify.{env.ROOT_DOMAIN} {
    tls {
        dns cloudflare {env.CLOUDFLARE_API_TOKEN}
        resolvers 1.1.1.1
    }

    # Define Internal IPs (Docker Network + LAN)
    @internal {
        remote_ip 172.20.0.0/24 192.168.0.0/16 127.0.0.1
        #IPv6 Ranges (Docker IPv6 + Localhost IPv6)
        remote_ip 2001:db8:abc2::/64 ::1
    }

    # Skip logging for internal IPs
    log_skip @internal

    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json {
            time_local
        }
    }

    # Re-use the same logic
    @geo_sg {
        maxmind_geolocation {
            db_path "/etc/caddy/GeoLite2-Country.mmdb"
            allow_countries SG
        }
    }

    handle @geo_sg {
        route {
            crowdsec
        }
        reverse_proxy http://gotify:80 {
            header_up X-Real-IP {remote_host}
        }
    }

    handle {
        respond "Access Denied: Geo-Block Active" 403
    }
}